# Dockerfile for vLLM on s390x architecture with dependencies, PyTorch, torchvision, and Apache Arrow
FROM ubuntu:22.04
USER root

RUN apt-get update -y && apt-get install -y \
    git wget curl vim libnuma-dev libsndfile-dev libprotobuf-dev protobuf-compiler \
    build-essential ffmpeg libsm6 libxext6 libgl1 python3 python3-pip cmake ninja-build \
    cargo libjpeg-dev libpng-dev zlib1g-dev libavcodec-dev libavformat-dev libswscale-dev \
    libtiff-dev libwebp-dev llvm-dev libclang-dev clang libssl-dev g++ \
    python3-distutils python3-setuptools libbz2-dev liblz4-dev libzstd-dev \
    libsnappy-dev rapidjson-dev libboost-dev liborc-dev pkg-config libopenblas-dev

RUN python3 -m pip install --upgrade pip setuptools

RUN curl https://sh.rustup.rs -sSf | sh -s -- -y && \
    . "$HOME/.cargo/env"

WORKDIR /tmp/arrow
RUN git clone https://github.com/apache/arrow.git && \
    cd arrow/cpp && \
    mkdir release && cd release && \
    cmake -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_INSTALL_PREFIX=/usr/local \
          -DARROW_PYTHON=ON \
          -DARROW_PARQUET=ON \
          -DARROW_ORC=ON \
          -DARROW_FILESYSTEM=ON \
          -DARROW_WITH_LZ4=ON \
          -DARROW_WITH_ZSTD=ON \
          -DARROW_WITH_SNAPPY=ON \
          -DARROW_JSON=ON \
          -DARROW_CSV=ON \
          -DPROTOBUF_PROTOC_EXECUTABLE=/usr/bin/protoc \
          -DARROW_DEPENDENCY_SOURCE=BUNDLED \
          -DARROW_DATASET=libarrow_dataset.so \
          .. && \
    make -j$(nproc) && make install

ENV CMAKE_PREFIX_PATH=/usr/local/lib/cmake:$CMAKE_PREFIX_PATH
ENV LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH

COPY . /workspace/vllm
WORKDIR /workspace/vllm

ARG GIT_REPO_CHECK=0
RUN --mount=type=bind,source=.git,target=.git \
    if [ "$GIT_REPO_CHECK" != 0 ]; then bash tools/check_repo.sh; fi

RUN mkdir -p /root/.cache/pip && chmod -R 777 /root/.cache/pip

RUN --mount=type=cache,target=/root/.cache/pip \
    --mount=type=cache,target=/root/.cache/ccache \
    pip install --no-cache-dir -v \
        'cmake>=3.26' ninja packaging 'setuptools-scm>=8' wheel jinja2 \
        --extra-index-url https://download.pytorch.org/whl/nightly/cpu \
        -r requirements-cpu.txt

ARG TORCH_VISION_VERSION=v0.20.1
RUN git clone https://github.com/pytorch/vision.git && \
    cd vision && \
    git checkout $TORCH_VISION_VERSION && \
    python3 setup.py bdist_wheel && \
    pip install --no-cache-dir dist/*.whl && \
    rm -rf dist

RUN python3 -m pip install --upgrade setuptools

RUN --mount=type=cache,target=/root/.cache/pip \
    --mount=type=cache,target=/root/.cache/ccache \
    VLLM_TARGET_DEVICE=cpu python3 setup.py build_ext --inplace && \
    VLLM_TARGET_DEVICE=cpu python3 setup.py bdist_wheel && \
    pip install --no-cache-dir dist/*.whl && \
    rm -rf dist

ENTRYPOINT ["/usr/bin/python3", "-m", "vllm.entrypoints.openai.api_server"]